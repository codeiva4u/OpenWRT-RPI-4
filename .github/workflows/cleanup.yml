name: Cleanup Old Builds

on:
  schedule:
    - cron: '0 2 * * 0'  # Run weekly on Sunday at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
    - name: Delete old workflow runs
      run: |
        # Keep only the latest 10 workflow runs
        echo "🧹 Cleaning up old workflow runs..."
        
        # Get workflow runs older than 7 days
        gh api repos/${{ github.repository }}/actions/runs \
          --paginate \
          --jq '.workflow_runs[] | select(.created_at < (now - 7*24*3600 | strftime("%Y-%m-%dT%H:%M:%SZ"))) | .id' \
        | head -20 \
        | xargs -I {} gh api repos/${{ github.repository }}/actions/runs/{} -X DELETE || true
        
        echo "✅ Workflow cleanup completed"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Delete old releases
      run: |
        echo "🗂️ Cleaning up old releases..."
        
        # Keep only the latest 3 releases
        gh api repos/${{ github.repository }}/releases \
          --jq '.[3:] | .[] | .id' \
        | xargs -I {} gh api repos/${{ github.repository }}/releases/{} -X DELETE || true
        
        echo "✅ Release cleanup completed"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Delete old artifacts
      run: |
        echo "📦 Cleaning up old artifacts..."
        
        # Delete artifacts older than 30 days
        gh api repos/${{ github.repository }}/actions/artifacts \
          --paginate \
          --jq '.artifacts[] | select(.created_at < (now - 30*24*3600 | strftime("%Y-%m-%dT%H:%M:%SZ"))) | .id' \
        | xargs -I {} gh api repos/${{ github.repository }}/actions/artifacts/{} -X DELETE || true
        
        echo "✅ Artifact cleanup completed"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}