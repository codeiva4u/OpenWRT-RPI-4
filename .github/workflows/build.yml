name: Build OpenWrt Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up OpenWrt Image Builder
        run: |
          # Using the user-specified stable release and correct file extension.
          OPENWRT_VERSION="24.10.2"
          TARGET_DEVICE="bcm27xx-bcm2711"
          IMAGE_BUILDER_URL="https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets/${TARGET_DEVICE}/openwrt-imagebuilder-${OPENWRT_VERSION}-${TARGET_DEVICE}.Linux-x86_64.tar.zst"

          echo "Downloading correct Image Builder from: ${IMAGE_BUILDER_URL}"
          wget -O imagebuilder.tar.zst "${IMAGE_BUILDER_URL}"
          # The zstd package is needed to decompress .zst files
          sudo apt-get update && sudo apt-get install -y zstd
          tar -I zstd -xf imagebuilder.tar.zst
          # The directory name might vary slightly, use a wildcard to be safe.
          mv openwrt-imagebuilder-* openwrt-imagebuilder
          cd openwrt-imagebuilder

      - name: Prepare custom files
        run: |
          # Copy all custom configuration files to the image builder
          cp -r $GITHUB_WORKSPACE/files ./openwrt-imagebuilder/

      - name: Build custom OpenWrt image
        run: |
          cd openwrt-imagebuilder
          
          # Define packages to include
          PACKAGES="luci luci-compat luci-lib-ipkg luci-theme-argon luci-app-argon-config mwan3 kmod-usb-net-ipheth usb-tethering kmod-usb-net-rndis kmod-usb-net-cdc-ether kmod-usb-net-asix-ax88179 kmod-usb-net-rtl8152 wpa_supplicant-openssl"
          
          # Build the image for Raspberry Pi 4
          make image PROFILE="rpi-4" PACKAGES="${PACKAGES}" FILES="files"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-image
          path: openwrt-imagebuilder/bin/targets/bcm27xx/bcm2711/*.img.gz